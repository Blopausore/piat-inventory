<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supplier Orders</title>

    <!-- DataTables CSS and JS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.5/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.5/js/jquery.dataTables.min.js"></script>
</head>
<body>
    <h1>Supplier Orders</h1>
    <div style="margin-bottom: 20px;">
        <button id="exportBtn">Export to Excel</button>
        <button id="importBtn">Import Excel</button>
    </div>
    <table id="ordersTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Date</th>
                <th>Book No.</th>
                <th>Order No.</th>
                <th>Tax Invoice</th>
                <th>Supplier</th>
                <th>PC</th>
                <th>Stone</th>
                <th>H/NH</th>
                <th>Color</th>
                <th>Shape</th>
                <th>Cutting</th>
                <th>Size</th>
                <th>Carats</th>
                <th>Currency (US/THB)</th>
                <th>Price per Unit</th>
                <th>PER</th>
                <th>Total THB</th>
                <th>Weight per Piece</th>
                <th>Price $/ct</th>
                <th>Price $ per Piece</th>
                <th>Total USD</th>
                <th>Rate Avg 2019</th>
                <th>Remarks</th>
                <th>Credit Term</th>
                <th>Target Size</th>
            </tr>
        </thead>
    </table>
    <script>
        $(document).ready(function() {
            // Destroy old instance if needed
            if ($.fn.dataTable.isDataTable('#ordersTable')) {
                $('#ordersTable').DataTable().clear().destroy();
            }
        
            var table = $('#ordersTable').DataTable({
                "processing": true,
                "serverSide": true,
                "ajax": {
                    "url": "{% url 'supplier_orders_json' %}",
                    "type": "GET"
                },
                "pageLength": 25,
                "scrollX": true,
                "order": [[0, 'desc']],
                "columns": [
                    { "name": "date" },
                    { "name": "book_no" },
                    { "name": "order_no" },
                    { "name": "tax_invoice" },
                    { "name": "supplier" },
                    { "name": "number" },
                    { "name": "stone" },
                    { "name": "heating" },
                    { "name": "color" },
                    { "name": "shape" },
                    { "name": "cutting" },
                    { "name": "size" },
                    { "name": "carats" },
                    { "name": "currency" },
                    { "name": "price_cur_per_unit" },
                    { "name": "unit" },
                    { "name": "total_thb" },
                    { "name": "weight_per_piece" },
                    { "name": "price_usd_per_ct" },
                    { "name": "price_usd_per_piece" },
                    { "name": "total_usd" },
                    { "name": "rate_avg_2019" },
                    { "name": "remarks" },
                    { "name": "credit_term" },
                    { "name": "target_size" }
                ]
            });
        
            // CLICK HANDLER
            $('#ordersTable tbody').on('click', 'td', function() {
                var cell = table.cell($(this).closest('td'));
        
                if (!cell || !cell.index()) {
                    console.error("Cell not recognized.");
                    return;
                }
        
                var originalValue = cell.data();
                var newValue = prompt("Edit value:", originalValue);
        
                if (newValue !== null && newValue !== originalValue) {
                    var rowData = table.row(cell.index().row).data();
                    var fieldIndex = cell.index().column;
        
                    $.ajax({
                        url: "{% url 'supplier_order_update' %}",
                        method: "POST",
                        data: {
                            'order_id': rowData[2],  // order_no est en 3Ã¨me colonne
                            'field_index': fieldIndex,
                            'new_value': newValue,
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.success) {
                                table.ajax.reload(null, false);  // Reload sans perdre la page
                            } else {
                                alert("Server error: " + (response.error || "Unknown"));
                            }
                        },
                        error: function(xhr) {
                            alert("Failed to update: " + xhr.responseText);
                        }
                    });
                }
            });
            $('#exportBtn').on('click', function() {
                window.location.href = "{% url 'supplier_orders_export' %}";
            });
        
            // Import Button
            $('#importBtn').on('click', function() {
                window.location.href = "{% url 'supplier_orders_import_page' %}";
            });
        
        });
        </script>
        
            
</body>
</html>
